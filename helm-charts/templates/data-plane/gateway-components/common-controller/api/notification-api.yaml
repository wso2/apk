# Copyright (c) 2024, WSO2 LLC. (https://www.wso2.com) All Rights Reserved.
#
# WSO2 LLC. licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except
# in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the
# specific language governing permissions and limitations
# under the License.

{{- if and .Values.wso2.kgw.dp.enabled .Values.wso2.kgw.dp.commonController }}
apiVersion: "dp.wso2.com/v2alpha1"
kind: "RouteMetadata"
metadata:
  name: {{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api-routemetadata
  namespace: {{ .Release.Namespace }}
  labels:
    api-name: "{{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api"
    api-version: "1.0.0"
    managed-by: "kgw"
spec:
  api:
    name: {{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api
    version: 1.0.0
    context: /api/notification
---
apiVersion: "dp.wso2.com/v2alpha1"
kind: "RoutePolicy"
metadata:
  name: {{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api-routepolicy
  namespace: {{ .Release.Namespace }}
  labels:
    api-name: "{{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api"
    api-version: "1.0.0"
    managed-by: "kgw"
spec: {}
---
kind: "Backend"
apiVersion: "gateway.envoyproxy.io/v1alpha1"
metadata:
  name: {{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api-backend
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
spec:
  endpoints:
    - fqdn:
        hostname: {{ template "kubernetes-gateway-helm.resource.prefix" . }}-common-controller-service.{{ .Release.Namespace }}.svc
        port: 9543
---
apiVersion: "gateway.networking.k8s.io/v1"
kind: "HTTPRoute"
metadata:
  name: "{{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api-route"
  namespace: {{ .Release.Namespace }}
  labels:
    api-name: "{{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api"
    api-version: "1.0.0"
    managed-by: "kgw"
  annotations:
    "helm.sh/hook": post-install,post-upgrade
spec:
  hostnames:
    - "{{ .Values.wso2.kgw.listener.hostname | default "api.am.wso2.com"}}"
  rules:
  - matches:
    - path:
        type: "RegularExpression"
        value: "/api/notification/1.0.0/notify"
      method: "POST"
    filters:
    - type: ExtensionRef
      extensionRef:
        group: dp.wso2.com
        kind: RouteMetadata
        name: {{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api-routemetadata
    - type: ExtensionRef
      extensionRef:
        group: dp.wso2.com
        kind: RoutePolicy
        name: {{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api-routepolicy
    - type: URLRewrite
      urlRewrite:
        path:
            type: ReplaceFullPath
            replaceFullPath: /notify
    backendRefs:
    - group: "gateway.envoyproxy.io"
      kind: "Backend"
      name: "{{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api-backend"
  parentRefs:
  - group: "gateway.networking.k8s.io"
    kind: "Gateway"
    name: {{ .Values.wso2.kgw.dp.gateway.name | default "wso2-kgw-default" }}
    sectionName: "apilistener"
---
kind: "ConfigMap"
apiVersion: "v1"
metadata:
  name: "{{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api-definition"
  namespace: {{ .Release.Namespace }}
  labels:
    managed-by: "kgw"
  annotations:
    "helm.sh/hook": post-install,post-upgrade
binaryData:
  definition: "H4sIAAAAAAAA/31TTW/bMAz9K4LOi5N028W3dsghCJYUa7rLUhSqTc/qrI9KdFYv8H8fKTtrgwTzxTb5RL73SB2k82CV1zKXH7NZNpcfhNS2cjI/SNTYACXWDnWlC4XaWXF9u2RMCbEI2nOIENtaR84IH9xeU04oYaColdXRiMoFEcGW2v6kuH1fDR0dW2U7yzX3EOJQb05UZrKnWITAYZn/OMg2NJSrEX3Mp1MincGrMr6BrHBmup+f87oNrmyL1GkoJPuHVLRog8YuVS2hUm2D9P2Qkl5hHVn+NDHt+NO7iPyOrTEqdEdPOiZ/3nXwi0zAGkTsIoIZFXoVlAE8CrL0Q3jsPAy+089LC9TggsMgGCdcdeJgJr62EcUTiJ3cblaL9eO3xffNl+vtcrPeyYwLBXhpdYBS5hhaYPnYpbnSXAwD4NU3roS3fFGDUWkDmFlOBwLNTvbJHy4HEW9cmawpnEWwyR3lfTPSmj5Hpn04r+WenqHAZEag3QtIRqW0+wX2Us8+MUxzfoeTnWvDRBUFxDhJsUkNAUb8qeQhEr2zceh1NZvx69ThzSot3KdLuRtVilH3CJqfg+6tarF2Qf+hxoz6fKnUkuwKVjXiLi2kWITgaC37/67loIq2nDSQ2UnEEX3HDg+6/p15c5spXbHbVeN+J5A2PCU9TGwknGZ2f3K9kLTyvZJpIWhSfLgfnr9aQ7ylNgQAAA=="
---
apiVersion: gateway.networking.k8s.io/v1alpha3
kind: BackendTLSPolicy
metadata:
  name: {{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api-backend-tls
spec:
  targetRefs:
    - group: gateway.envoyproxy.io
      kind: Backend
      name: {{ template "kubernetes-gateway-helm.resource.prefix" . }}-notification-api-backend
  validation:
    caCertificateRefs:
      - name: {{ template "kubernetes-gateway-helm.resource.prefix" . }}-common-controller-server-cert
        group: ''
        kind: Secret
    hostname: {{ template "kubernetes-gateway-helm.resource.prefix" . }}-common-controller-service.{{ .Release.Namespace }}.svc
{{- end}}